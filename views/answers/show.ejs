<%- include('../partials/header'); -%>

<div class="loader hidden">
  <img src="/Rolling.gif" alt="Loading..." />
</div>

<div class="container">
  <% if(answer){ %>
    <div class="answer">
      <div class="card1">
        <h2><%= answer.topic %></h2>
        <div class="answer-meta">
          <span class="author">
            <i class="fas fa-user"></i> Author: <%= answer.author.name %>
          </span>
          <div class="vote-section">
            <button onclick="doupVote('<%= answer._id %>');" class="btn btn-sm">
              <i class="fas fa-thumbs-up"></i> Vote
            </button>
            <span class="votes-count">
              <i class="fas fa-star"></i> <%= answer.votes %> votes
            </span>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="answer-content">
          <p><%= answer.content %></p>
        </div>
      </div>
      
      <div class="comment-section">
        <h3><i class="fas fa-comments"></i> Comments</h3>
        
        <div class="comment-form">
          <form class="comentForm">
            <div class="form-group">
              <label for="comment">Add a Comment</label>
              <textarea name="comment" id="comment" rows="3" placeholder="Write your comment..." required></textarea>
            </div>
            <button type="submit" class="btn">
              <i class="fas fa-comment"></i> Post Comment
            </button>
          </form>
        </div>
        
        <% if(answer.comments.length===0){ %>
          <div class="card text-center">
            <h4><i class="fas fa-comment-slash"></i> No Comments Yet</h4>
            <p>Be the first to comment on this answer!</p>
          </div>
        <% } else { %>
          <div class="comments-list">
            <% console.log('Comments:', answer.comments); %>
            <% answer.comments.forEach(function(comment){ %>
              <div class="cc-box">
                <div class="comment-header">
                  <span class="comment-author">
                    <i class="fas fa-user-circle"></i> <%= comment.author ? comment.author.name : 'Unknown User' %>
                  </span>
                  <% if(user && comment.author && comment.author.id.equals(user._id)){ %>
                    <button type="button" class="btn btn-danger btn-sm" onclick="doDelete('<%= comment._id %>');">
                      <i class="fas fa-trash"></i>
                    </button>
                  <% } %>
                </div>
                <div class="comment-content">
                  <p><%= comment.topic %></p>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
    </div>
    
    <script>
      async function doupVote(answerID) {
        const loader = document.querySelector(".loader");
        loader.className = "loader";
        try {
          const res = await fetch("/answer/upvote", {
            method: "POST",
            body: JSON.stringify({ answerID }),
            headers: { "Content-Type": "application/json" },
          });
          const data = await res.json();
          if (data.msg === "success") {
            location.assign("/answer/show/<%= answer._id %>");
          }
        } catch (err) {
          console.log(err);
        }
      }
    </script>

    <script>
      async function doDelete(commentID) {
        const loader = document.querySelector(".loader");
        loader.className = "loader";
        try {
          const res = await fetch("/comment/delete", {
            method: "POST",
            body: JSON.stringify({ commentID }),
            headers: { "Content-Type": "application/json" },
          });
          
          if (res.status === 401) {
            alert("Please login to delete comments");
            window.location.href = "/login";
            return;
          }
          
          const data = await res.json();
          if (data.msg === "success") {
            location.reload();
          } else if (data.error) {
            alert(data.error);
          }
        } catch (err) {
          console.log(err);
          alert("Error deleting comment. Please try again.");
        } finally {
          loader.className = "loader hidden";
        }
      }
    </script>
    
    <script>
      const form = document.querySelector(".comentForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const loader = document.querySelector(".loader");
        loader.className = "loader";
        
        const topic = form.comment.value;
        if (!topic.trim()) {
          alert("Please enter a comment");
          loader.className = "loader hidden";
          return;
        }
        
        try {
          const res = await fetch("/answer/<%= answer._id %>/comment/new", {
            method: "POST",
            body: JSON.stringify({ topic }),
            headers: { 
              "Content-Type": "application/json"
            },
          });
          
          if (res.status === 401) {
            alert("Please login to comment");
            window.location.href = "/login";
            return;
          }
          
          const data = await res.json();
          if (data.commentID) {
            location.reload();
          } else if (data.error) {
            alert(data.error);
          }
        } catch (err) {
          console.log(err);
          alert("Error posting comment. Please try again.");
        } finally {
          loader.className = "loader hidden";
        }
      });
    </script>
  <% } else { %>
    <div class="card text-center">
      <h3><i class="fas fa-exclamation-triangle"></i> Answer Not Found</h3>
      <p>This answer does not exist or has been removed.</p>
      <a href="/smoothies" class="btn">
        <i class="fas fa-arrow-left"></i> Back to Questions
      </a>
    </div>
  <% } %>
</div>

<%- include('../partials/footer'); -%>
